#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir> <env-dir>

set -ex

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
#ENV_DIR=${3:-}


export CARGO_HOME="$CACHE_DIR/cargo"
export RUSTUP_HOME="$CACHE_DIR/rustup"
export PATH="$CARGO_HOME/bin:$PATH"

echo "-----> Install cargo"
cd "$CACHE_DIR"
if [ ! -x "rustup.sh" ]; then
    curl https://sh.rustup.rs -sSf > rustup.sh
    chmod u+x rustup.sh
fi
./rustup.sh -v -y --profile minimal

echo "-----> Compile the application"
#cargo build --release --manifest-path "$BUILD_DIR/Cargo.toml" --target-dir "$CACHE_DIR/target"
cargo install --path "$BUILD_DIR" --target-dir "$CACHE_DIR/target" --root "$BUILD_DIR"

#find "$CACHE_DIR/target/release" -maxdepth 1 -type f -executable -exec cp -a -t "$BUILD_DIR" {} \;
